window.RTCPeerConnection=window.webkitRTCPeerConnection||window.mozRTCPeerConnection,window.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;var DEBUG=!0,log=function(){if(DEBUG&&window.console){for(var a=-1,b=arguments.length,c=[],d='console.log("DEBUG", args)';++a<b;)c.push("args["+a+"]");d=new Function("args",d.replace(/args/,c.join(","))),d(arguments)}},Hello=function(a){this.options=a;var b=io.connect("http://localhost:3000"),c=new RTCPeerConnection({iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}]},{optional:[{RtpDataChannels:!0}]}),d=function(a){log("created answer",a),c.setLocalDescription(a),b.emit("answer",a)};c.onaddstream=function(a){log("remote stream",a),this.options.remote.src=URL.createObjectURL(a.stream)}.bind(this),c.onicecandidate=function(a){log("local ice",a),a.candidate&&(b.emit("ice",a.candidate),c.onicecandidate=null)},c.onopen=function(){log("open",arguments)},b.on("offer",function(a){log("offer",a),c.setRemoteDescription(new RTCSessionDescription(a)),c.createAnswer(d)}),b.on("answer",function(a){log("answer",a),c.setRemoteDescription(new RTCSessionDescription(a))}.bind(this)),b.on("ice",function(a){log("remote ice",a),c.addIceCandidate(new RTCIceCandidate(a))}),b.on("call",function(a){log(a,"is calling you"),this.pendingCalls[a]=new Date}.bind(this)),this.socket=b,this.stream=null,this.pendingCalls={},this.peerConnection=c};Hello.prototype.register=function(a){this.socket.emit("register",a)},Hello.prototype.call=function(a){var b={audio:!0,video:!0},c=function(b){this.stream=b,this.peerConnection.addStream(this.stream),this.options.local.src=URL.createObjectURL(b),this.socket.emit("call",a)}.bind(this),d=function(){console.error(arguments)};navigator.getUserMedia(b,c,d)},Hello.prototype.answer=function(a){var b=this.pendingCalls[a],c={audio:!0,video:!0};if(b){var d=function(a){this.stream=a,this.options.local.src=URL.createObjectURL(a),this.peerConnection.addStream(this.stream),this.peerConnection.createOffer(function(a){this.peerConnection.setLocalDescription(a),this.socket.emit("offer",a)}.bind(this))}.bind(this),e=function(){console.error(arguments)};navigator.getUserMedia(c,d,e)}};